<div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
        
        <div class="card shadow-lg border-0">
            
            <div class="card-header bg-success text-white"> 
                <h2 class="h4 mb-0">
                    <i class="bi bi-cart-fill me-2"></i> Registrar Nueva Venta
                </h2>
            </div>
            
            <form (ngSubmit)="onSubmit(saleForm)" #saleForm="ngForm">
                <div class="card-body p-4">
                    
                    <h5 class="mb-3 text-secondary"><i class="bi bi-person-check-fill me-1"></i> Selección de Cliente</h5>
                    
                    <div class="mb-3">
                        <label for="cliente" class="form-label fw-bold">Cliente <span class="text-danger">*</span></label>
                        <select
                            [(ngModel)]="sale.customerId"
                            name="customerId"
                            required
                            class="form-select"
                            #customerId="ngModel"
                        >
                            <option [ngValue]="null" disabled>Seleccione un Cliente</option>
                            <option *ngFor="let customer of customers" [ngValue]="customer.idCustomer">
                                {{ customer.name }}
                            </option>
                        </select>
                        <div *ngIf="customerId.invalid && (customerId.dirty || customerId.touched)" class="text-danger mt-1 small">El cliente es obligatorio.</div>
                    </div>

                    <div class="alert alert-info py-2" role="alert">
                        <i class="bi bi-info-circle-fill me-1"></i> La **Fecha y Hora** de la venta se registrarán automáticamente al momento de pulsar el botón **"Finalizar Venta"**.
                    </div>
                    
                    <hr class="my-4">

                    <h5 class="mb-3 text-secondary"><i class="bi bi-list-check me-1"></i> Ítems Vendidos</h5>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Agregar Repuestos</label>
                        
                        <div class="p-3 mb-3 border rounded bg-light">
                            
                            <div *ngFor="let detail of sale.details; let i = index" class="border p-3 mb-3 rounded shadow-sm bg-white">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0 text-primary">Detalle #{{ i + 1 }}</h6>
                                    <button 
                                        type="button" 
                                        class="btn btn-sm btn-outline-danger" 
                                        (click)="deleteDetail(detail.id)">
                                        <i class="bi bi-trash-fill"></i> Eliminar
                                    </button> 
                                </div>

                                <div class="row">
                                    <div class="col-md-8 mb-3">
                                        <label for="partId{{i}}" class="form-label small">Repuesto <span class="text-danger">*</span></label>
                                        <select
                                            [(ngModel)]="detail.partId"
                                            name="partId{{i}}"
                                            required
                                            class="form-select form-select-sm"
                                            #partId="ngModel"
                                        >
                                            <option [ngValue]="null" disabled>Seleccione un Repuesto</option>
                                            <option *ngFor="let part of parts" [ngValue]="part.idPart">
                                                {{ part.name }} (Stock: {{ part.stock }})
                                            </option>
                                        </select>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label for="quantity{{i}}" class="form-label small">Cantidad <span class="text-danger">*</span></label>
                                        <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            [(ngModel)]="detail.quantity"
                                            name="quantity{{i}}"
                                            required
                                            min="1"
                                            placeholder="Mín. 1"
                                            #cantidad="ngModel"
                                        />
                                    </div>
                                </div>
                                
                                <div *ngIf="partId.invalid && (partId.dirty || partId.touched)" class="text-danger mt-1 small">Seleccionar un repuesto es obligatorio.</div>
                                <div *ngIf="quantity.invalid && (quantity.dirty || quantity.touched)" class="text-danger mt-1 small">La cantidad debe ser mínimo 1.</div>
                            </div>
                            
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-outline-primary" (click)="addDetail()">
                                    <i class="bi bi-plus-circle-fill me-1"></i> Añadir Otro Repuesto
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <hr>

                    <div class="d-flex justify-content-end pt-3">
                        
                        <a [routerLink]="['/sales']" class="btn btn-outline-secondary me-2">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                        
                        <button 
                            type="submit" 
                            class="btn btn-success"
                            [disabled]="!saleForm.form.valid || sale.details.length === 0"
                        >
                            <i class="bi bi-receipt me-1"></i> Finalizar Venta
                        </button>
                    </div>

                </div>
            </form>
        </div>
    </div>
</div>